# Figma Defaults Research — Which Can Be Reconstructed from Jay-HTML?

**Status: COMPLETE** — Research and implementation done. All tests pass (19/21, 2 pre-existing).

**Related:** Design Log #93 (Phase 5 cleanup), #91.1 (gaps inventory, agent prompts)

## Summary

Investigated every field listed in the agent prompt across Groups A–E. For each field: checked what the forward converter produces as CSS, whether the reverse converter can reconstruct it, whether the deserializer needs it, and the recommended action.

**Key finding:** Most default values can be safely removed from the serializer. The deserializer uses guarded checks (`if (doc.X)`) throughout — missing properties keep Figma's own defaults. The reverse converter already reconstructs most non-default values from CSS signals.

---

## Research Table

| Field | CSS Signal | Can Reconstruct? | Deserializer Needs? | Recommendation | Priority |
|-------|-----------|-----------------|--------------------|--------------------|----------|
| **Group A: Auto-layout child properties** | | | | | |
| `layoutPositioning: "AUTO"` | `position: relative` (auto-layout child) vs `position: absolute` | YES — `position: absolute` → ABSOLUTE; relative/no position → AUTO | YES (guarded: `if (doc.layoutPositioning)`) | REMOVE "AUTO" from serializer; converter ADD "ABSOLUTE" when `position: absolute` | Medium |
| `layoutGrow: 0` | No `flex-grow` (default) vs `flex-grow: 1` | YES — `flex-grow > 0` reconstructable | YES (guarded: `if (doc.layoutGrow !== undefined)`) | REMOVE `0` from serializer (only emit non-zero) | Low — `layoutSizingHorizontal` supersedes it |
| `layoutAlign: "INHERIT"` | No `align-self` (default) vs `align-self: center/stretch/etc.` | YES — `align-self` CSS maps directly | YES (guarded: `if (doc.layoutAlign)`) | REMOVE "INHERIT" from serializer (only emit non-INHERIT) | Low |
| `layoutSizingHorizontal` | `width: Npx` → FIXED, `width: fit-content` → HUG, `width: 100%`/`flex-grow: 1` → FILL | YES — converter already reconstructs all three | YES (guarded) | KEEP in serializer (not a default — varies per node). Converter already handles. | N/A |
| `layoutSizingVertical` | `height: Npx` → FIXED, `height: fit-content` → HUG, `height: 100%`/`flex-grow: 1` → FILL | YES — converter already reconstructs all three | YES (guarded) | KEEP in serializer (not a default — varies per node). Converter already handles. | N/A |
| **Group B: Frame layout properties** | | | | | |
| `layoutWrap: "NO_WRAP"` | No `flex-wrap` (default) vs `flex-wrap: wrap` | YES — `flex-wrap: wrap` → WRAP | YES (guarded: `if (doc.layoutWrap)`) | REMOVE "NO_WRAP" from serializer (only emit "WRAP") | Low |
| `overflowDirection: "NONE"` | No scroll overflow (default) vs `overflow-x: auto` etc. | YES — overflow CSS maps directly | YES (guarded: `if (doc.overflowDirection)`) | REMOVE "NONE" from serializer. Forward converter already defaults to 'NONE' when missing. | Low |
| `clipsContent: false` | No `overflow: hidden` → false; `overflow: hidden` → true | YES | YES (guarded: `if (typeof doc.clipsContent === 'boolean')`) | KEEP — `false` is actually non-default for Figma frames (`figma.createFrame()` defaults to `true`). Must be explicitly set. | N/A |
| `cornerRadius: 0` | No `border-radius` or `border-radius: 0px` | YES — converter already parses `border-radius` | YES (guarded) | REMOVE `0` from serializer (Figma default). Also remove `border-radius: 0px` from forward converter. | Low |
| `primaryAxisAlignItems: "MIN"` | `justify-content: flex-start` (CSS default for flex) | YES — converter already defaults to MIN | YES (guarded: `if (doc.primaryAxisAlignItems)`) | REMOVE "MIN" from serializer (Figma auto-layout default). Converter already handles. | Low |
| `counterAxisAlignItems: "MIN"` | `align-items: flex-start` (CSS default for flex) | YES — converter already defaults to MIN | YES (guarded: `if (doc.counterAxisAlignItems)`) | REMOVE "MIN" from serializer (Figma auto-layout default). Converter already handles. | Low |
| **Group C: Stroke/fill defaults** | | | | | |
| `fills: []` | `background: transparent` or no background | YES (absence = no fills) | Skipped when empty (`if (doc.fills && Array.isArray(doc.fills))`) | REMOVE empty `[]` from serializer (only emit non-empty) | Medium |
| `strokes: []` | No `border-*` CSS | YES (absence = no strokes) | Skipped when empty | REMOVE empty `[]` from serializer (only emit non-empty) | Medium |
| `strokeWeight` when no strokes | N/A — no CSS border | N/A | Read independently, but meaningless without strokes | REMOVE stroke weights when `strokes` is empty | Medium |
| `strokeAlign: "INSIDE"` | CSS borders are always inside (no equivalent for outside/center) | Converter already emits "INSIDE" when strokes exist | YES (guarded) | REMOVE "INSIDE" from serializer (Figma default). Converter already adds when needed. | Low |
| `visible: true` on fills/strokes | No CSS signal (always visible in CSS) | N/A — not needed | `toFill()` defaults to `true` when missing | REMOVE `visible: true` from fill/stroke objects (only emit when `false`) | Medium |
| `opacity: 1` on fills/strokes | From rgba alpha channel | YES — converter parses rgba opacity | `toFill()` defaults to `1` when missing | REMOVE `opacity: 1` from fill/stroke objects (only emit when < 1) | Medium |
| **Group D: Text defaults** | | | | | |
| `textAlignHorizontal: "LEFT"` | `text-align: left` (CSS default) | YES — converter parses `text-align` | YES (guarded: `if (doc.textAlignHorizontal)`) | REMOVE "LEFT" from serializer (Figma default). Converter/deserializer both default to LEFT. | Low |
| `textAlignVertical: "TOP"` | No CSS equivalent | NO — Figma-specific concept | YES (guarded) | REMOVE "TOP" from serializer (Figma default). Converter emits as constant default. Not needed — Figma defaults to TOP. | Low |
| `textCase: "ORIGINAL"` | No `text-transform` = ORIGINAL | YES (absence = ORIGINAL) | Deserializer does NOT read `textCase` | REMOVE "ORIGINAL" from serializer. No consumer needs the default. | Low |
| `textTruncation: "DISABLED"` | No `text-overflow: ellipsis` | YES (absence = DISABLED) | Deserializer does NOT read `textTruncation` | REMOVE "DISABLED" from serializer. No consumer needs the default. | Low |
| `textAutoResize: "WIDTH_AND_HEIGHT"` | No fixed width → WIDTH_AND_HEIGHT; fixed width + auto height → HEIGHT | Partially — can infer "HEIGHT" from fixed width. Can't distinguish "NONE". | YES (guarded: `if (doc.textAutoResize)`) | REMOVE "WIDTH_AND_HEIGHT" from serializer (Figma default). Converter should reconstruct "HEIGHT" from fixed-width text. | Medium |
| `letterSpacing: {value:0, unit:"PERCENT"}` | No `letter-spacing` CSS | YES (absence = default) | YES (guarded) | REMOVE `{value:0, unit:"PERCENT"}` from serializer (Figma default). Converter already emits when non-zero. | Low |
| `lineHeight: {unit:"AUTO"}` | `line-height: normal` → AUTO | YES — converter maps `line-height: normal` → AUTO | YES (guarded) | REMOVE `{unit:"AUTO"}` from serializer (Figma default). | Low |
| `textDecoration: "NONE"` | No `text-decoration` CSS | YES (absence = NONE) | Deserializer does NOT read `textDecoration` | REMOVE "NONE" from serializer. No consumer needs the default. | Low |
| **Group E: Positional defaults** | | | | | |
| `x: 0, y: 0` for auto-layout children | Figma computes position in auto-layout | NO — can't know from CSS which x/y are "real" vs layout-computed | YES (always: `node.x = doc.x`) | IGNORE — removing requires knowing parent context at serialization time. Figma recalculates for auto-layout children anyway. | Low |
| `rotation: 0` | Already handled (Phase 5) — only emit non-zero | N/A | N/A | DONE — already cleaned up in Design Log #93 Phase 5 | N/A |

---

## Grouped Recommendations

### 1. Remove from serializer — safe, no consumer needs the default

These are Figma default values that both the forward converter and deserializer handle gracefully when missing. No behavioral change.

**Serializer: `sceneNode.ts`**
- `layoutPositioning: "AUTO"` → only emit when `"ABSOLUTE"`
- `layoutGrow: 0` → only emit when `> 0`
- `layoutAlign: "INHERIT"` → only emit when not `"INHERIT"`
- `textAlignHorizontal: "LEFT"` → only emit non-LEFT
- `textAlignVertical: "TOP"` → only emit non-TOP
- `textCase: "ORIGINAL"` → only emit non-ORIGINAL
- `textTruncation: "DISABLED"` → only emit non-DISABLED
- `textAutoResize: "WIDTH_AND_HEIGHT"` → only emit non-default ("HEIGHT" or "NONE")
- `letterSpacing: {value:0, unit:"PERCENT"}` → only emit when value ≠ 0
- `lineHeight: {unit:"AUTO"}` → only emit when not AUTO
- `textDecoration: "NONE"` → only emit non-NONE

**Serializer: `frameNode.ts`**
- `layoutWrap: "NO_WRAP"` → only emit `"WRAP"`
- `overflowDirection: "NONE"` → only emit non-NONE
- `cornerRadius: 0` → only emit non-zero
- `primaryAxisAlignItems: "MIN"` → only emit non-MIN
- `counterAxisAlignItems: "MIN"` → only emit non-MIN
- `fills: []` → don't emit empty array
- `strokes: []` → don't emit empty array
- `strokeWeight/strokeTopWeight/...` when `strokes: []` → don't emit
- `strokeAlign: "INSIDE"` → only emit non-INSIDE (CENTER/OUTSIDE)
- `visible: true` on fills/strokes → only emit when `false`
- `opacity: 1` on fills/strokes → only emit when `< 1`

**Estimated JSON reduction:** ~15-25 properties per node, significant reduction in fixture file size.

### 2. Add to converter from CSS — reconstructable and needed

These fields CAN be reconstructed from CSS and SHOULD be added to the reverse converter for correctness:

| Field | CSS Signal | Where in converter |
|-------|-----------|-------------------|
| `layoutPositioning: "ABSOLUTE"` | `position: absolute` | `stylesToFigmaProps()` — add `layoutPositioning` output |
| `textAutoResize: "HEIGHT"` | TEXT node with explicit `width: Npx` and no explicit height | `convertTextElement()` / `tryCollapseTextWrapper()` — check if width is FIXED |

The converter already handles most fields correctly. Only these two gaps exist.

### 3. Emit as constant default — not in CSS but deserializer needs a value

These were already handled by the converter's `buildTextDefaults()` function:

| Field | Converter already emits? | Action |
|-------|------------------------|--------|
| `textAlignVertical: "TOP"` | YES (`buildTextDefaults`) | None needed — already correct |
| `letterSpacing: {value:0, unit:"PERCENT"}` | YES (`buildTextDefaults`) | Can REMOVE from converter too — Figma defaults to this |
| `textCase: "ORIGINAL"` | YES (`buildTextDefaults`) | Can REMOVE from converter too — Figma defaults to this |
| `textTruncation: "DISABLED"` | YES (`buildTextDefaults`) | Can REMOVE from converter too — deserializer doesn't read it |
| `textAutoResize: "WIDTH_AND_HEIGHT"` | YES (`buildTextDefaults`) | Can REMOVE — Figma defaults to this. Only need to emit "HEIGHT" when detected. |

**Note:** The converter's `buildTextDefaults()` function currently emits several defaults that the deserializer doesn't actually need. These can be stripped to reduce noise in the converter output. The only constant default worth keeping is `textAlignVertical: "TOP"` if non-TOP values need to be supported later.

### 4. Needs headless browser — requires rendering to compute

| Field | Why headless? | Feasible? |
|-------|--------------|-----------|
| Content dimensions (HUG sizing) | Text wrapping, font metrics affect actual height | YES but overkill — jay-html uses inline styles, so dimensions are mostly explicit |
| x/y for absolute-positioned children | Relative to parent, could use `getBoundingClientRect()` | YES but unnecessary — forward converter already emits `left`/`top` CSS |

**Assessment:** A headless browser is NOT needed for the fields investigated in this prompt. The jay-html uses inline styles throughout (the forward converter puts all CSS inline), so `getComputedStyle()` wouldn't add information beyond what's already in the style attribute. The headless browser is more relevant for:
- Component/variant permutation rendering (Prompt 2 scope)
- Content-dependent layout measurement (rare edge case)

**Architecture note:** The CLI already has Playwright as a dev dependency for testing. Adding it to the import pipeline is architecturally feasible but adds ~200ms startup overhead per import. Not recommended for default-value reconstruction.

### 5. Ignore — acceptable loss

| Field | Why ignore? |
|-------|------------|
| `x: 0, y: 0` for auto-layout children | Figma recalculates positions for auto-layout children. The serializer can't easily determine if a node is in auto-layout (sceneNode.ts doesn't have parent context). The converter correctly emits `x: 0, y: 0` which Figma overrides. |
| `clipsContent: false` | NOT a default — Figma frames default to `true`. The value `false` is meaningful and must continue to be serialized. |
| `layoutSizingHorizontal/Vertical` | Not defaults — these vary per node (FIXED/HUG/FILL). Both serializer and converter handle correctly. |

---

## Special Notes

### `clipsContent` is NOT a default
The prompt listed `clipsContent: false` as a default, but `figma.createFrame()` sets `clipsContent = true`. So `false` is actually a non-default value that MUST be serialized. The converter should also emit `clipsContent: false` when overflow is not hidden (this is currently missing — the converter only sets `true` for `overflow: hidden`).

### Forward converter emits redundant CSS defaults
The forward converter (`utils.ts`) emits some CSS that is already the browser default:
- `border-radius: 0px` → browsers default to no radius
- `justify-content: flex-start` → CSS flex default
- `align-items: flex-start` → CSS flex default

These could be removed from the forward converter for cleaner HTML, though it's low priority.

### `buildTextDefaults()` in the reverse converter can be simplified
The converter's `buildTextDefaults()` emits 5 constant defaults that the deserializer mostly doesn't need:

```typescript
// Current — emits defaults the deserializer doesn't need:
function buildTextDefaults(textProps) {
    return {
        textAlignVertical: 'TOP',           // Figma default — not needed
        letterSpacing: { value: 0, unit: 'PERCENT' },  // Figma default — not needed
        textCase: 'ORIGINAL',               // Deserializer doesn't read — not needed
        textTruncation: 'DISABLED',         // Deserializer doesn't read — not needed
        textAutoResize: 'WIDTH_AND_HEIGHT', // Figma default — not needed
    };
}
```

**Recommendation:** Remove `buildTextDefaults()` entirely or replace with only meaningful non-default values:

```typescript
// Proposed — only emit what's actually needed:
function buildTextDefaults(textProps, layoutProps) {
    const defaults = {};
    // Only emit textAutoResize when it's "HEIGHT" (non-default)
    if (layoutProps.width !== undefined && !layoutProps.layoutSizingHorizontal) {
        defaults.textAutoResize = 'HEIGHT';
    }
    return defaults;
}
```

---

## Implementation Priority

1. **HIGH** — Remove empty `fills: []` and `strokes: []` from serializer (reduces noise significantly)
2. **HIGH** — Remove `visible: true` and `opacity: 1` from fill/stroke objects
3. **MEDIUM** — Remove default values from `sceneNode.ts` (layoutPositioning, layoutGrow, layoutAlign, text defaults)
4. **MEDIUM** — Remove default values from `frameNode.ts` (layoutWrap, overflowDirection, cornerRadius, axis align defaults)
5. **MEDIUM** — Add `layoutPositioning: "ABSOLUTE"` to reverse converter when CSS has `position: absolute`
6. **LOW** — Simplify `buildTextDefaults()` in reverse converter
7. **LOW** — Clean up redundant CSS defaults in forward converter

**All changes in priorities 1-4 are serializer-only** (jay-desktop-poc repo) and are fully backward-compatible — no consumer breaks when these defaults are omitted.

---

## Implementation Results

Implemented priorities 1–6 from the research findings in a single pass.

### Phase 1: Serializer default removal (jay-desktop-poc)

**`sceneNode.ts`** — 3 auto-layout child defaults + 8 text defaults:
- `layoutPositioning`: only emit `"ABSOLUTE"` (skip default `"AUTO"`)
- `layoutGrow`: only emit when `> 0` (skip default `0`)
- `layoutAlign`: only emit when not `"INHERIT"` (skip default)
- `textAlignHorizontal`: only emit non-`"LEFT"`
- `textAlignVertical`: only emit non-`"TOP"`
- `letterSpacing`: only emit when value ≠ 0 (for PERCENT) or non-PERCENT unit
- `lineHeight`: only emit when unit ≠ `"AUTO"`
- `textDecoration`: only emit non-`"NONE"`
- `textCase`: only emit non-`"ORIGINAL"`
- `textTruncation`: only emit non-`"DISABLED"`
- `textAutoResize`: only emit non-`"WIDTH_AND_HEIGHT"`
- Text fill `opacity`: only emit when `!== 1`

**`frameNode.ts`** — 8 frame defaults + fill/stroke cleanup:
- `primaryAxisAlignItems`: only emit non-`"MIN"`
- `counterAxisAlignItems`: only emit non-`"MIN"`
- `layoutWrap`: only emit `"WRAP"` (skip default `"NO_WRAP"`)
- `overflowDirection`: only emit non-`"NONE"`
- `cornerRadius`: only emit non-`0`
- `fills`: only emit non-empty array
- `strokes`: only emit non-empty (after filtering invisible)
- `strokeWeight`/`strokeTopWeight`/etc.: only emit when strokes exist
- `strokeAlign`: only emit non-`"INSIDE"`
- Fill/stroke `visible`: only emit when `false`
- Fill/stroke `opacity`: only emit when `< 1`

### Phase 2: Reverse converter improvements (jay)

**`from-jay-html.ts`:**
- Added `layoutPositioning: "ABSOLUTE"` detection from CSS `position: absolute`
- Added `layoutPositioning` to `FigmaLayoutProps` interface and `convertFrameElement` output
- Simplified `buildTextDefaults()` — removed 5 constant defaults that are Figma's own defaults (deserializer handles missing). Now only emits `textAutoResize: "HEIGHT"` when text has fixed pixel width (non-default, inferred from CSS).

### Phase 3: Test fixture updates (jay)

Updated 10 expected.figma.json fixtures to remove text defaults that the converter no longer emits:
- `component-set-enum`, `font-style-mapping`, `hello-world`, `layout-sizing`, `layout-sizing-fixed-vs-fill`, `non-figma-source-basic`, `text-defaults`, `text-nesting`, `text-styles`, `wix-store-product-page`

### Test Results

- Forward converter fixtures: **6/6 passing**
- Reverse converter (from-jay-html): **19/21 passing** (2 pre-existing failures: `non-figma-source-basic`, `wix-store-product-page`)
- Zero regressions introduced

### Files Changed

**Repo: `jay-desktop-poc`**

| File | Change |
|------|--------|
| `pluginsCommon/lib/serialization/serializers/sceneNode.ts` | Skip default values for layoutPositioning, layoutGrow, layoutAlign, and 8 text properties |
| `pluginsCommon/lib/serialization/serializers/frameNode.ts` | Skip default values for axis alignment, layoutWrap, overflowDirection, cornerRadius; only emit fills/strokes/weights when non-empty; strip visible:true and opacity:1 from fills/strokes |

**Repo: `jay`**

| File | Change |
|------|--------|
| `packages/jay-stack/stack-cli/lib/vendors/figma/converters/from-jay-html.ts` | Added layoutPositioning ABSOLUTE from CSS; simplified buildTextDefaults to only emit non-default textAutoResize:"HEIGHT" |
| 10 expected.figma.json fixture files | Removed text defaults (textAlignVertical, letterSpacing, textCase, textTruncation, textAutoResize) |
